<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.market.gaji.board.mapper.BoardMapper">

	<!-- 전체 게시물 조회 : 사용자의 주소에 해당하는 게시물 -->
	<select id="getListBoard" parameterType="int" resultMap="board">
		select a.boardnum, a.title, a.price, a.sell, a.readcnt, a.regdate, b.nickname, b.membernum
		from tbl_board a join tbl_member b
		on a.membernum = b.membernum
		where b.addressnum = #{addressnum}
		order by sell desc, regdate desc
	</select>
	
	<select id="getListPagingBoard" resultMap="board">
		<![CDATA[
		select boardnum, title, price, sell, readcnt, regdate, nickname, membernum
		from(
			select rownum rn, boardnum, title, price, sell, readcnt, regdate, nickname, membernum
			from(
				select rownum rn, a.boardnum, a.title, a.price, a.sell, a.readcnt, a.regdate, b.nickname, b.membernum
				from tbl_board a join tbl_member b
				on a.membernum = b.membernum
				where b.addressnum = #{addressnum}
				order by sell desc, boardnum desc)
			where rownum <= #{pageNum} * #{amount})
		where rn > (#{pageNum} - 1) * #{amount}
		]]>
	</select>
	
	<select id="getTotalCount" resultType="int">
		SELECT count(*)	
		from(
			select a.boardnum, a.title, a.price, a.sell, a.readcnt, a.regdate, b.nickname, b.membernum
			from tbl_board a join tbl_member b
			on a.membernum = b.membernum
			where b.addressnum = 3
			order by sell desc, regdate DESC)
	</select>
	
	<!-- 내가 쓴 게시물 조회 -->
	<select id="getListMyBoard" parameterType="int" resultMap="board">
		select a.boardnum, a.title, a.price, a.sell, a.readcnt, a.regdate, b.nickname, b.membernum
		from tbl_board a join tbl_member b
		on a.membernum = b.membernum
		where b.membernum = #{membernum}
		order by sell desc, regdate desc
	</select>
	
	<!-- 게시물 상세 조회 -->
	<select id="getDetailBoard" parameterType="int" resultMap="board">
		select a.boardnum, a.title, a.price, a.content, a.sell, a.readcnt, a.regdate, 
			   b.categoryname, c.nickname, b.categorynum, c.membernum
		from tbl_board a
		join tbl_category b on a.categorynum = b.categorynum
		join tbl_member c on a.membernum = c.membernum
		where boardnum = #{boardnum}
	</select>
	
	<resultMap type="BoardVO" id="board">
		<id column="boardnum" property="boardnum"></id>
		<result column="title" property="title"/>
		<result column="price" property="price"/>
		<result column="content" property="content"/>
		<result column="sell" property="sell"/>
		<result column="readcnt" property="readcnt"/>
		<result column="regdate" property="regdate"/>
		<result column="categorynum" property="categorynum"/>
		<result column="membernum" property="membernum"/>
		
		<collection javaType="MemberVO" property="member">
			<id column="membernum" property="membernum"/>
			<result column="email" property="email"/>
			<result column="password" property="password"/>
			<result column="nickname" property="nickname"/>
			<result column="phone" property="phone"/>
			<result column="regdate" property="regdate"/>
			<result column="addressnum" property="addressnum"/>		
		</collection>
		
		<collection javaType="CategoryVO" property="category">
			<id column="categorynum" property="categorynum"/>
			<result column="categoryname" property="categoryname"/>
		</collection>
	</resultMap>
	
	
	<!-- 게시물 등록 -->
	<insert id="registerBoard" parameterType="BoardVO">
		insert into tbl_board (boardnum, title, price, content, categorynum, membernum)
		values (board_seq.nextval, #{title}, #{price}, #{content}, #{categorynum}, #{membernum})
	</insert>
	
	<!-- 게시글 삭제 -->
	<delete id="deleteBoard" parameterType="int">
		delete
		from tbl_board
		where boardnum = #{boardnum}
	</delete>
	
	<!-- 게시글 수정 -->
	<update id="modifyBoard" parameterType="BoardVO">
		update tbl_board set
		title = #{title}, price = #{price}, content = #{content}, sell = #{sell}, categorynum = #{categorynum}
		where boardnum = #{boardnum}
	</update>
	
	<!-- 조회수 증가 -->
	<update id="modifyPlusReadCnt" parameterType="int">
		update tbl_board set
		readcnt = readcnt + 1
		where boardnum = #{boardnum}
	</update>
	
	

</mapper>