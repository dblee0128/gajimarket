package com.market.gaji.member.controller;

import javax.servlet.http.HttpSession;
import javax.validation.Valid;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.bind.support.SessionStatus;

import com.market.gaji.member.domain.ChangePwCommand;
import com.market.gaji.member.domain.MemberVO;
import com.market.gaji.member.service.MemberService;

@Controller
@SessionAttributes("member")
@RequestMapping("/myInfo/member")
public class MyInfoMemberController {
	
	@Autowired
	private MemberService memberService;
	
	// 내 정보 메인 페이지로 이동
	@RequestMapping
	public String myInfo() {
		return "/myInfo/myInfo";
	}
	
	// 회원 정보 조회
	@RequestMapping(value="/get")
	public String getDetailMyInfo(HttpSession session, Model model) {
		MemberVO member = memberService.getMember((String)session.getAttribute("email")); // 세션을 이용해서 값 가져오기
		model.addAttribute("member", member);
		return "/myInfo/member/get";
	}
	
	// 회원 탈퇴
	@RequestMapping(value="/delete")
	public String deleteMember(HttpSession session, Model model) {
		String email = (String)session.getAttribute("email");
		String nickname = (String)session.getAttribute("nickname");
		model.addAttribute("email", email);
		model.addAttribute("nickname", nickname);
		return "/myInfo/member/delete";
	}
	
	@RequestMapping(value="/delete", method=RequestMethod.POST)
	public String deleteMember(String email, String password, HttpSession session, Model model) {
		
		MemberVO member = memberService.getMember(email); // 입력한 정보를 가져오기 (email은 hidden으로 넘겨줄거야)
		System.out.println("member: " + member);
		
		if(member.getPassword().equals(password)) { // 비밀번호가 일치하면
			memberService.deleteMember(email, password); // 삭제 진행
			session.invalidate(); // 세션도 끊어주기
			return "/myInfo/member/deleteSuccess";
		} else { // 비밀번호가 일치하지 않으면
			model.addAttribute("msg", "비밀번호가 일치하지 않습니다.");
			return "/myInfo/member/delete";
		}
	
	}
	
	// 회원 정보 수정 - 주소, 핸드폰 번호 수정
	@RequestMapping(value="/modify")
	public String modifyMember(HttpSession session, Model model) {
		// 세션에 저장된 email 값을 가져오기 = 가져올 수 있다는 것은 로그인이 되어있다는 것 = 즉, 수정이 자유로운 상태
		String email = (String)session.getAttribute("email");
		MemberVO member = memberService.getMember(email); // 멤버 정보 가져오기
		model.addAttribute("member", member); // 이 단계에서 @SessionAttributes("member")에 의해 세션까지 저장됨
		return "/myInfo/member/modify";
	}
	
	// RegisterCommand에서의 유효성 검증은 더 많은거야. (주소, 핸드폰 번호만 검증하면 되는데)
	// 그래서 GET 단계에서 세션에 값을 저장해두고 --> @SessionAttributes("member")
	// POST로 넘어오면 member가 이미 값이 채워진 상태로 오게되어 내가 바꾸고픈 주소, 핸드폰 번호만 변경되어 넘어감
	// 이렇게 해야 유효성 검증에 오류가 생기지 않음
	@RequestMapping(value="/modify", method=RequestMethod.POST)
	public String modifyMember(@ModelAttribute("member") @Valid MemberVO member, BindingResult bindingResult, 
							   SessionStatus sessionStatus, Model model) {
		MemberVO check = memberService.getPhoneMember(member.getPhone());
		System.out.println("check:" + check);
		
		if(bindingResult.hasErrors()) { // 유효성 검사에 에러가 발생할 경우
			if(member.getAddressnum() == 0) {
				model.addAttribute("msg", "주소를 선택해주세요.");
				return "myInfo/member/modify"; 
			}
			return "/myInfo/member/modify";
		} else {
			if(member.getAddressnum() == 0) {
				model.addAttribute("msg2", "주소를 선택해주세요.");
				return "myInfo/member/modify"; 
			} 
			memberService.modifyMember(member);
			sessionStatus.setComplete(); //세션에 담겨 있던 member 제거
			return "redirect:/myInfo";
		}
	}
	
	// 회원 정보 수정 - 비밀번호 수정
	@RequestMapping(value="/modifyPw")
	public String modifyPwMember(HttpSession session, Model model) {
		String email = (String)session.getAttribute("email");
		MemberVO member = memberService.getMember(email);
		model.addAttribute("member", member);
		model.addAttribute("changePwCmd", new ChangePwCommand());
		return "/myInfo/member/modifyPw";
	}
	
	@RequestMapping(value="/modifyPw", method=RequestMethod.POST)
	public String modifyPwMember(@ModelAttribute("changePwCmd") @Valid ChangePwCommand changePwCmd, 
								 BindingResult bindingResult, MemberVO member, Model model) {
		
		// 1.유효성 검사에서 에러가 발생할 경우
		if(bindingResult.hasErrors()) {
			System.out.println(bindingResult.toString());
			return "/myInfo/member/modifyPw";
		}
		
		// 2.DB의 비밀번호와 현재 비밀번호가 일치하지 않을 경우
		MemberVO detail = memberService.getMember(member.getEmail());
		if(!(changePwCmd.getCurrentPassword().equals(detail.getPassword()))) {
			model.addAttribute("msg1", "현재 비밀번호가 일치하지 않습니다.");
			return "/myInfo/member/modifyPw";
		}
		
		// 3.변경할 비밀번호와 변경할 비밀번호 확인이 일치하지 않을 경우
		if(!(changePwCmd.getConfirmPassword().equals(changePwCmd.getPassword()))) {
			model.addAttribute("msg2", "변경할 비밀번호가 일치하지 않습니다.");
			return "/myInfo/member/modifyPw";
		}
		
		// 모든 조건이 만족할 경우
		member.setEmail(changePwCmd.getEmail());
		member.setPassword(changePwCmd.getPassword());
		memberService.modifyPwMember(member);
		return "redirect:/myInfo";
	}
	
		
}